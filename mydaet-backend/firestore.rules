rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /** -------------------------
     * Helpers
     * ------------------------- */
    function signedIn() {
      return request.auth != null;
    }

    function signedInUser() {
      return signedIn();
    }

    function tokenRole() {
      return (request.auth != null && request.auth.token.role != null)
        ? request.auth.token.role
        : null;
    }

    function tokenOfficeId() {
      return (request.auth != null && request.auth.token.officeId != null)
        ? request.auth.token.officeId
        : null;
    }

    function userDoc() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function hasUserData() {
      return signedIn() && userDoc().data != null;
    }

    function roleRaw() {
      return (request.auth != null && request.auth.token.role != null)
        ? request.auth.token.role
        : (hasUserData() && userDoc().data.role != null
            ? userDoc().data.role
            : null);
    }

    function role() {
      return roleRaw() in ["admin", "super_admin", "superAdmin", "superadmin", "SUPER_ADMIN", "SUPERADMIN"]
        ? "super_admin"
        : (roleRaw() in ["office_admin", "officeAdmin", "officeadmin", "OFFICE_ADMIN"]
            ? "office_admin"
            : (roleRaw() in ["moderator", "MODERATOR"]
                ? "moderator"
                : "resident"));
    }

    function officeId() {
      return (request.auth != null && request.auth.token.officeId != null)
        ? request.auth.token.officeId
        : (hasUserData() && userDoc().data.officeId != null
            ? userDoc().data.officeId
            : null);
    }

    function officeName() {
      return (request.auth != null && request.auth.token.officeName != null)
        ? request.auth.token.officeName
        : (hasUserData() && userDoc().data.officeName != null
            ? userDoc().data.officeName
            : null);
    }

    function isActive() {
      return (request.auth != null && request.auth.token.isActive != null)
        ? request.auth.token.isActive
        : (hasUserData() && userDoc().data.isActive != null
            ? userDoc().data.isActive
            : true);
    }

    function activeUser() {
      return signedIn() && isActive();
    }

    function isSuperAdmin() {
      return role() == "super_admin";
    }

    function isOfficeAdmin() {
      return role() == "office_admin";
    }

    function isModerator() {
      return role() == "moderator";
    }

    function isResident() {
      return role() == "resident";
    }

    function isStaff() {
      return isSuperAdmin() || isOfficeAdmin() || isModerator();
    }

    function isSuperAdminByDoc() {
      return hasUserData() && userDoc().data.role in ["super_admin", "admin"];
    }

    function isStaffByDoc() {
      return hasUserData() && userDoc().data.role in ["super_admin", "admin", "office_admin", "moderator"];
    }

    function officeIdByDoc() {
      return hasUserData() && userDoc().data.officeId != null
        ? userDoc().data.officeId
        : null;
    }

    function officeNameByDoc() {
      return hasUserData() && userDoc().data.officeName != null
        ? userDoc().data.officeName
        : null;
    }

    function hasOfficeId(data) {
      return data.keys().hasAny(["officeId"]) && data.officeId != null && data.officeId != "";
    }

    function hasNonEmptyString(data, field) {
      return data.keys().hasAny([field]) && data[field] is string && data[field] != "";
    }

    function officeAllowed(data) {
      return !hasOfficeId(data) || (officeId() != null && data.officeId == officeId());
    }

    function isOwner(uid) {
      return signedIn() && request.auth.uid == uid;
    }

    function isAllowedUserSelfUpdate() {
      return request.resource.data.diff(resource.data).changedKeys()
        .hasOnly(["displayName", "photoUrl", "phone", "updatedAt"]);
    }

    function hasNoPrivilegedUserFieldChanges() {
      return !request.resource.data.diff(resource.data).changedKeys()
        .hasAny(["role", "status", "uid", "email", "createdAt", "officeId", "officeName", "isActive"]);
    }

    function dtsOfficeAllowed(data) {
      return isSuperAdmin()
        || isSuperAdminByDoc()
        || (
          (isStaff() || isStaffByDoc())
          && (
            (officeId() != null && data.currentOfficeId == officeId())
            || (officeIdByDoc() != null && data.currentOfficeId == officeIdByDoc())
            || (officeName() != null && data.currentOfficeName != null && data.currentOfficeName == officeName())
            || (officeNameByDoc() != null && data.currentOfficeName != null && data.currentOfficeName == officeNameByDoc())
            || (data.pendingTransfer != null && officeId() != null && data.pendingTransfer.toOfficeId == officeId())
            || (data.pendingTransfer != null && officeIdByDoc() != null && data.pendingTransfer.toOfficeId == officeIdByDoc())
            || (data.pendingTransfer != null && officeName() != null && data.pendingTransfer.toOfficeName != null && data.pendingTransfer.toOfficeName == officeName())
            || (data.pendingTransfer != null && officeNameByDoc() != null && data.pendingTransfer.toOfficeName != null && data.pendingTransfer.toOfficeName == officeNameByDoc())
            || (data.pendingTransfer != null && data.pendingTransfer.toUid != null && data.pendingTransfer.toUid == request.auth.uid)
            || (data.currentCustodianUid != null && data.currentCustodianUid == request.auth.uid)
          )
        );
    }

    function dtsCanRead(data) {
      return signedInUser() && (
        isSuperAdmin()
        || isSuperAdminByDoc()
        || dtsOfficeAllowed(data)
        || (isResident() && data.submittedByUid == request.auth.uid)
      );
    }

    function dtsQrDoc(qrCode) {
      return get(/databases/$(database)/documents/dts_qr_codes/$(qrCode));
    }

    function dtsDocById(docId) {
      return get(/databases/$(database)/documents/dts_documents/$(docId));
    }

    function validLifecycleStatus(statusValue) {
      return statusValue in ["draft", "published", "archived"];
    }

    function canWritePublishedState(statusValue) {
      return validLifecycleStatus(statusValue)
        && (isSuperAdmin() || isOfficeAdmin() || statusValue == "draft");
    }

    function officeMatches(targetOfficeId) {
      return isSuperAdmin()
        || (officeId() != null && targetOfficeId != null && targetOfficeId != "" && officeId() == targetOfficeId);
    }

    function defaultPublicHearingOffices() {
      return ["SANGGUNIANG_BAYAN", "OFFICE_OF_THE_MAYOR"];
    }

    function publicHearingConfigPath() {
      return /databases/$(database)/documents/system_config/rbac;
    }

    function publicHearingOfficeAllowed(targetOfficeId) {
      return targetOfficeId in defaultPublicHearingOffices()
        || (exists(publicHearingConfigPath())
          && get(publicHearingConfigPath()).data.publicHearingOffices is list
          && targetOfficeId in get(publicHearingConfigPath()).data.publicHearingOffices);
    }

    function docTypeOfficeAllowed(docType, targetOfficeId) {
      return (
        (docType in ["ordinance", "resolution"]
          && targetOfficeId == "SANGGUNIANG_BAYAN"
          && officeMatches("SANGGUNIANG_BAYAN"))
        || (docType == "executive_order"
          && targetOfficeId == "OFFICE_OF_THE_MAYOR"
          && officeMatches("OFFICE_OF_THE_MAYOR"))
        || (docType == "public_hearing"
          && targetOfficeId != null
          && targetOfficeId != ""
          && officeMatches(targetOfficeId)
          && publicHearingOfficeAllowed(targetOfficeId))
      );
    }

    function jobOfficeAllowed(targetOfficeId) {
      return isSuperAdmin()
        || (isOfficeAdmin() && officeId() != null && targetOfficeId != null && targetOfficeId != "" && officeId() == targetOfficeId);
    }

    /** -------------------------
     * USERS
     * /users/{uid}
     * ------------------------- */
    match /users/{uid} {
      allow create: if isOwner(uid)
        && request.resource.data.uid == request.auth.uid
        && request.resource.data.role == "resident"
        && (!("officeId" in request.resource.data) || request.resource.data.officeId == null)
        && (!("officeName" in request.resource.data) || request.resource.data.officeName == null)
        && (!("isActive" in request.resource.data) || request.resource.data.isActive == true);

      allow read: if signedInUser() && isOwner(uid);
      allow read: if signedInUser() && tokenRole() in ["super_admin", "superAdmin", "superadmin", "admin", "SUPER_ADMIN", "SUPERADMIN"];
      allow read: if signedInUser()
        && tokenRole() in ["office_admin", "officeAdmin", "officeadmin", "OFFICE_ADMIN"]
        && tokenOfficeId() != null
        && resource.data.officeId == tokenOfficeId()
        && resource.data.role in ["resident", "moderator", "office_admin"];

      allow update: if activeUser() && (
        (
          isOwner(uid)
          && hasNoPrivilegedUserFieldChanges()
          && isAllowedUserSelfUpdate()
        )
        || (
          isSuperAdmin()
          && (resource.data.role != "super_admin" || request.resource.data.role == "super_admin")
          && (
            request.resource.data.role in ["office_admin", "moderator"]
              ? (request.resource.data.officeId != null && request.resource.data.officeId != "")
              : true
          )
        )
      );

      allow delete: if activeUser() && isSuperAdmin();

      match /fcmTokens/{token} {
        allow read, write: if signedInUser() && isOwner(uid);
      }

      match /notifications/{notificationId} {
        allow read: if signedInUser() && isOwner(uid);
        allow update, delete: if signedInUser() && isOwner(uid);
        allow create: if false;
      }

      match /announcementReads/{announcementId} {
        allow read, write: if signedInUser() && isOwner(uid);
      }
    }

    /** -------------------------
     * AUDIT LOGS
     * /audit_logs/{id}
     * ------------------------- */
    match /audit_logs/{id} {
      allow read: if signedInUser() && (
        isSuperAdmin()
        || (isOfficeAdmin() && officeId() != null && resource.data.officeId == officeId())
      );
      allow write: if false;
    }

    /** -------------------------
     * REPORTS
     * /reports/{reportId}
     * ------------------------- */

    match /stats/{docId} {
      allow read: if signedInUser() && isStaff();
      allow write: if false;
    }

    match /stats/daily/{dayId} {
      allow read: if signedInUser() && isStaff();
      allow write: if false;
    }

    match /stats/assignees/{uid} {
      allow read: if signedInUser() && isStaff() && (isSuperAdmin() || request.auth.uid == uid);
      allow write: if false;
    }

    match /reports/{reportId} {
      // TODO: Backfill report.officeId for stricter office scoping.

      // Resident can create report and must stamp ownership
      allow create: if activeUser()
        && request.resource.data.createdByUid == request.auth.uid
        && request.resource.data.status == "submitted"
        && hasNonEmptyString(request.resource.data, "officeId")
        && hasNonEmptyString(request.resource.data, "officeName");

      // Read:
      // - staff (moderator/office admin/super admin) can list and view reports
      // - residents can only read their own reports
      allow read: if signedInUser() && (
        isStaff()
        || resource.data.createdByUid == request.auth.uid
      );

      // Update:
      // - Resident can edit ONLY their own report content BEFORE it is handled
      //   and CANNOT change workflow fields (status/assignedToUid/createdByUid)
      // - SuperAdmin can update any
      // - Office admin can update within office scope
      // - Assigned moderator can update status only
      allow update: if activeUser() && (
        (
          resource.data.createdByUid == request.auth.uid
          && (resource.data.status == "submitted" || resource.data.status == "in_review")
          && request.resource.data.createdByUid == resource.data.createdByUid
          && request.resource.data.assignedToUid == resource.data.assignedToUid
          && request.resource.data.status == resource.data.status
          && !request.resource.data.diff(resource.data).changedKeys()
            .hasAny([
              "officeId",
              "lastActionByUid",
              "lastActionByEmail",
              "lastActionByName",
              "lastActionByRole",
              "lastActionAt",
              "archived",
              "archivedAt",
              "archivedByUid",
              "archivedByEmail",
              "archivedByName",
              "archivedByRole"
            ])
        )
        || isSuperAdmin()
        || (
          isOfficeAdmin()
          && officeAllowed(resource.data)
          && request.resource.data.officeId == resource.data.officeId
        )
        || (
          isModerator()
          && resource.data.assignedToUid == request.auth.uid
          && request.resource.data.diff(resource.data).changedKeys()
            .hasOnly([
              "status",
              "updatedAt",
              "lastActionByUid",
              "lastActionByEmail",
              "lastActionByName",
              "lastActionByRole",
              "lastActionAt"
            ])
          && request.resource.data.lastActionByUid == request.auth.uid
          && request.resource.data.lastActionByRole == roleRaw()
          && request.resource.data.lastActionByEmail == request.auth.token.email
        )
      );

      // Delete only super admin
      allow delete: if activeUser() && isSuperAdmin();

      // Optional: messages subcollection
      match /messages/{messageId} {
        allow read: if signedInUser() && (
          get(/databases/$(database)/documents/reports/$(reportId)).data.createdByUid == request.auth.uid
          || isSuperAdmin()
          || (isOfficeAdmin() && officeAllowed(get(/databases/$(database)/documents/reports/$(reportId)).data))
          || (
            isModerator()
            && get(/databases/$(database)/documents/reports/$(reportId)).data.assignedToUid == request.auth.uid
          )
        );

        allow create: if activeUser() && (
          isSuperAdmin()
          || (isOfficeAdmin() && officeAllowed(get(/databases/$(database)/documents/reports/$(reportId)).data))
          || (
            isModerator()
            && get(/databases/$(database)/documents/reports/$(reportId)).data.assignedToUid == request.auth.uid
          )
        );

        allow update, delete: if false;
      }

      match /history/{historyId} {
        allow read: if signedInUser() && (
          get(/databases/$(database)/documents/reports/$(reportId)).data.createdByUid == request.auth.uid
          || isSuperAdmin()
          || (isOfficeAdmin() && officeAllowed(get(/databases/$(database)/documents/reports/$(reportId)).data))
          || (
            isModerator()
            && get(/databases/$(database)/documents/reports/$(reportId)).data.assignedToUid == request.auth.uid
          )
        );
        allow write: if false;
      }
    }

    /** -------------------------
     * DTS DOCUMENTS
     * /dts_documents/{docId}
     * ------------------------- */
    match /dts_documents/{docId} {
      allow create: if activeUser()
        && isStaff()
        && hasNonEmptyString(request.resource.data, "qrCode")
        && hasNonEmptyString(request.resource.data, "trackingNo")
        && hasNonEmptyString(request.resource.data, "publicPinHash")
        && hasNonEmptyString(request.resource.data, "title")
        && hasNonEmptyString(request.resource.data, "docType")
        && hasNonEmptyString(request.resource.data, "currentOfficeId")
        && request.resource.data.status == "RECEIVED"
        && !exists(/databases/$(database)/documents/dts_qr_index/$(request.resource.data.qrCode))
        && exists(/databases/$(database)/documents/dts_qr_codes/$(request.resource.data.qrCode))
        && dtsQrDoc(request.resource.data.qrCode).data.status == "unused"
        && (
          isSuperAdmin()
          || (officeId() != null && request.resource.data.currentOfficeId == officeId())
        );

      allow read: if dtsCanRead(resource.data);

      // All state mutations must run through callable functions (server-side checks).
      allow update: if false;

      allow delete: if activeUser() && isSuperAdmin();

      match /timeline/{eventId} {
        allow read: if signedInUser() && isStaff();
        allow create: if activeUser()
          && isStaff()
          && dtsOfficeAllowed(dtsDocById(docId).data)
          && request.resource.data.keys().hasAll(["type", "byUid", "createdAt"])
          && request.resource.data.byUid == request.auth.uid
          && request.resource.data.type is string;
        allow update, delete: if false;
      }
    }

    match /dts_qr_index/{qrCode} {
      allow read: if signedInUser() && isStaff();
      allow create: if activeUser() && isStaff()
        && !exists(/databases/$(database)/documents/dts_qr_index/$(qrCode));
      allow update, delete: if false;
    }

    match /dts_qr_codes/{qrCode} {
      allow read: if signedInUser() && isStaff();
      allow create: if false;
      allow update: if activeUser() && isStaff()
        && resource.data.status == "unused"
        && request.resource.data.status == "used"
        && request.resource.data.docId != null;
      allow delete: if false;
    }

    match /dts_counters/{year} {
      allow read: if signedInUser() && isStaff();
      allow create, update: if activeUser() && isStaff();
      allow delete: if false;
    }

    /** -------------------------
     * ADVERTISEMENTS
     * /ads/{adId}
     * ------------------------- */
    match /ads/{adId} {
      allow read: if signedInUser() && (
        resource.data.status == "published"
        || isStaff()
      );

      allow create: if activeUser() && isStaff()
        && request.resource.data.createdByUid == request.auth.uid
        && request.resource.data.status in ["draft", "published"];

      allow update, delete: if activeUser() && isStaff();

      match /reactions/{uid} {
        allow read: if signedInUser() && (isOwner(uid) || isStaff());
        allow create, update: if signedInUser() && isOwner(uid)
          && request.resource.data.type in ["like", "dislike"];
        allow delete: if signedInUser() && isOwner(uid);
      }
    }

    /** -------------------------
     * ANNOUNCEMENTS
     * /announcements/{announcementId}
     * ------------------------- */
    match /announcements/{announcementId} {
      allow read: if resource.data.status == "published"
        || (signedInUser() && isStaff());

      allow create: if activeUser() && isStaff()
        && request.resource.data.createdByUid == request.auth.uid
        && request.resource.data.status in ["draft", "published"];

      allow update, delete: if activeUser() && isStaff();

      match /views/{viewerUid} {
        allow read: if signedInUser() && (isOwner(viewerUid) || isSuperAdmin());
        allow create, update: if signedInUser() && request.auth.uid == viewerUid;
        allow delete: if false;
      }
    }

    /** -------------------------
     * PUBLIC DOCUMENTS
     * /public_docs/{docId}
     * ------------------------- */
    match /public_docs/{docId} {
      allow read: if resource.data.status == "published"
        || (signedInUser() && isStaff());

      allow create: if activeUser()
        && isStaff()
        && request.resource.data.docType in ["ordinance", "resolution", "executive_order", "public_hearing"]
        && canWritePublishedState(request.resource.data.status)
        && docTypeOfficeAllowed(request.resource.data.docType, request.resource.data.officeId)
        && request.resource.data.createdByUid == request.auth.uid;

      allow update: if activeUser()
        && isStaff()
        && request.resource.data.docType in ["ordinance", "resolution", "executive_order", "public_hearing"]
        && canWritePublishedState(request.resource.data.status)
        && docTypeOfficeAllowed(request.resource.data.docType, request.resource.data.officeId)
        && request.resource.data.createdByUid == resource.data.createdByUid;

      allow delete: if false;
    }

    /** -------------------------
     * JOBS
     * /jobs/{jobId}
     * ------------------------- */
    match /jobs/{jobId} {
      allow read: if resource.data.status == "published"
        || (signedInUser() && isStaff());

      allow create: if activeUser()
        && (isSuperAdmin() || isOfficeAdmin())
        && canWritePublishedState(request.resource.data.status)
        && jobOfficeAllowed(request.resource.data.officeId)
        && request.resource.data.createdByUid == request.auth.uid;

      allow update: if activeUser()
        && (isSuperAdmin() || isOfficeAdmin())
        && canWritePublishedState(request.resource.data.status)
        && jobOfficeAllowed(request.resource.data.officeId)
        && request.resource.data.createdByUid == resource.data.createdByUid;

      allow delete: if false;
    }

    /** -------------------------
     * OFFICES
     * /offices/{officeId}
     * ------------------------- */
    match /offices/{officeId} {
      allow read: if signedInUser();
      allow create, update, delete: if activeUser() && (isSuperAdmin() || isSuperAdminByDoc());
    }

    /** -------------------------
     * APPOINTMENTS (Phase 2 prep)
     * /appointments/{appointmentId}
     * ------------------------- */
    match /appointments/{appointmentId} {
      allow read: if activeUser() && (
        isSuperAdmin()
        || ((isOfficeAdmin() || isModerator())
          && officeId() != null
          && resource.data.officeId == officeId())
      );
      allow create, update, delete: if activeUser() && (
        isSuperAdmin()
        || (isOfficeAdmin()
          && officeId() != null
          && request.resource.data.officeId == officeId())
      );
    }

    /** -------------------------
     * OFFICE SLOTS (Phase 2 prep)
     * /office_slots/{slotId}
     * ------------------------- */
    match /office_slots/{slotId} {
      allow read: if activeUser() && (
        isSuperAdmin()
        || ((isOfficeAdmin() || isModerator())
          && officeId() != null
          && resource.data.officeId == officeId())
      );
      allow create, update, delete: if activeUser() && (
        isSuperAdmin()
        || (isOfficeAdmin()
          && officeId() != null
          && request.resource.data.officeId == officeId())
      );
    }

    /** -------------------------
     * Default deny
     * ------------------------- */
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
