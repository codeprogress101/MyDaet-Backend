rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    function signedIn() {
      return request.auth != null;
    }

    function roleRaw() {
      return (request.auth != null && request.auth.token.role != null)
        ? request.auth.token.role
        : null;
    }

    function userDoc() {
      return firestore.get(/databases/(default)/documents/users/$(request.auth.uid));
    }

    function hasUserData() {
      return signedIn() && userDoc().data != null;
    }

    function roleRawByDoc() {
      return hasUserData() && userDoc().data.role != null
        ? userDoc().data.role
        : null;
    }

    function roleCandidate() {
      return roleRaw() != null
        ? roleRaw()
        : roleRawByDoc();
    }

    function roleString() {
      return roleCandidate() is string
        ? roleCandidate()
        : "";
    }

    function roleMatches(pattern) {
      return roleString() != "" && roleString().matches(pattern);
    }

    function hasSuperAdminFlag() {
      return request.auth != null && (
        request.auth.token.superAdmin == true
        || request.auth.token.isSuperAdmin == true
        || request.auth.token.super_admin == true
      );
    }

    function hasOfficeAdminFlag() {
      return request.auth != null && (
        request.auth.token.officeAdmin == true
        || request.auth.token.office_admin == true
        || request.auth.token.isOfficeAdmin == true
      );
    }

    function hasModeratorFlag() {
      return request.auth != null && (
        request.auth.token.moderator == true
        || request.auth.token.isModerator == true
        || request.auth.token.clerk == true
      );
    }

    function role() {
      return (
        hasSuperAdminFlag()
        || roleMatches("^[\\s]*[sS][uU][pP][eE][rR][ _-]?[aA][dD][mM][iI][nN][\\s]*$")
      )
        ? "super_admin"
        : (
          hasOfficeAdminFlag()
          || roleMatches("^[\\s]*[aA][dD][mM][iI][nN][\\s]*$")
          || roleMatches("^[\\s]*[oO][fF][fF][iI][cC][eE][ _-]?[aA][dD][mM][iI][nN][\\s]*$")
        )
            ? "admin"
            : (
              hasModeratorFlag()
              || roleMatches("^[\\s]*[mM][oO][dD][eE][rR][aA][tT][oO][rR][\\s]*$")
              || roleMatches("^[\\s]*[cC][lL][eE][rR][kK][\\s]*$")
            )
                ? "moderator"
                : "resident";
    }

    function officeId() {
      return (request.auth != null && request.auth.token.officeId != null)
        ? request.auth.token.officeId
        : (hasUserData() && userDoc().data.officeId != null
            ? userDoc().data.officeId
            : null);
    }

    function officeName() {
      return (request.auth != null && request.auth.token.officeName != null)
        ? request.auth.token.officeName
        : (hasUserData() && userDoc().data.officeName != null
            ? userDoc().data.officeName
            : null);
    }

    function isActive() {
      return (request.auth != null && request.auth.token.isActive != null)
        ? request.auth.token.isActive
        : (hasUserData() && userDoc().data.isActive != null
            ? userDoc().data.isActive
            : true);
    }

    function activeUser() {
      return signedIn() && isActive();
    }

    function isSuperAdmin() {
      return role() == "super_admin";
    }

    function isOfficeAdmin() {
      return role() == "admin";
    }

    function isModerator() {
      return role() == "moderator";
    }

    function isStaff() {
      return isSuperAdmin() || isOfficeAdmin() || isModerator();
    }

    function reportDoc(reportId) {
      return firestore.get(/databases/(default)/documents/reports/$(reportId));
    }

    function reportOfficeAllowed(reportId) {
      return reportDoc(reportId).data.officeId == null
        || reportDoc(reportId).data.officeId == ""
        || (officeId() != null && reportDoc(reportId).data.officeId == officeId());
    }

    function canReadReport(reportId) {
      return activeUser() && (
        isStaff()
        || reportDoc(reportId).data.createdByUid == request.auth.uid
      );
    }

    function canWriteReportNote(reportId) {
      return activeUser() && (
        reportDoc(reportId).data.createdByUid == request.auth.uid
        || isSuperAdmin()
        || (isOfficeAdmin() && reportOfficeAllowed(reportId))
        || (isModerator() && reportDoc(reportId).data.assignedToUid == request.auth.uid)
      );
    }

    function dtsDoc(docId) {
      return firestore.get(/databases/(default)/documents/dts_documents/$(docId));
    }

    function dtsOfficeAllowed(docId) {
      return isSuperAdmin()
        || (
          isStaff()
          && (
            (officeId() != null && dtsDoc(docId).data.currentOfficeId == officeId())
            || (officeName() != null && dtsDoc(docId).data.currentOfficeName != null && dtsDoc(docId).data.currentOfficeName == officeName())
            || (dtsDoc(docId).data.currentCustodianUid != null && dtsDoc(docId).data.currentCustodianUid == request.auth.uid)
            || (
              dtsDoc(docId).data.pendingTransfer != null
              && (
                (officeId() != null && dtsDoc(docId).data.pendingTransfer.toOfficeId == officeId())
                || (officeName() != null && dtsDoc(docId).data.pendingTransfer.toOfficeName != null && dtsDoc(docId).data.pendingTransfer.toOfficeName == officeName())
                || (dtsDoc(docId).data.pendingTransfer.toUid != null && dtsDoc(docId).data.pendingTransfer.toUid == request.auth.uid)
              )
            )
          )
        );
    }

    function canReadDts(docId) {
      return activeUser() && (
        isSuperAdmin()
        || dtsOfficeAllowed(docId)
      );
    }

    function validImageUpload(maxMb) {
      return request.resource != null
        && request.resource.size < maxMb * 1024 * 1024
        && request.resource.contentType != null
        && request.resource.contentType.matches("image/.*");
    }

    function validPdfUpload(maxMb) {
      return request.resource != null
        && request.resource.size < maxMb * 1024 * 1024
        && request.resource.contentType != null
        && request.resource.contentType.matches("application/pdf.*");
    }

    function validAttachmentUpload(maxMb) {
      return request.resource != null
        && request.resource.size < maxMb * 1024 * 1024
        && request.resource.contentType != null
        && (
          request.resource.contentType.matches("image/.*")
          || request.resource.contentType.matches("application/pdf.*")
          || request.resource.contentType == "application/msword"
          || request.resource.contentType == "application/vnd.openxmlformats-officedocument.wordprocessingml.document"
        );
    }

    match /ads/{adId}/{fileName} {
      allow read: if true;
      allow write: if activeUser() && isStaff() && validImageUpload(10);
    }

    match /announcements/{announcementId}/{fileName} {
      allow read: if true;
      allow write: if false;
    }

    match /posts/{postId}/{fileName} {
      allow read: if true;
      allow write: if activeUser() && isStaff() && validImageUpload(10);
    }

    match /public_docs/{docType}/pdf/{filePath=**} {
      allow read: if true;
      allow write: if activeUser()
        && isStaff()
        && docType in ["ordinance", "resolution", "executive_order", "public_hearing", "generic"]
        && validPdfUpload(25);
    }

    match /public_docs/{docType}/attachments/{filePath=**} {
      allow read: if true;
      allow write: if activeUser()
        && isStaff()
        && docType in ["ordinance", "resolution", "executive_order", "public_hearing", "generic"]
        && validAttachmentUpload(15);
    }

    match /reports/{uid}/{reportId}/{fileName} {
      allow read: if canReadReport(reportId);
      allow write: if activeUser()
        && request.auth.uid == uid
        && reportDoc(reportId).data.createdByUid == request.auth.uid
        && validAttachmentUpload(15);
    }

    match /report_notes/{reportId}/{messageId}/{fileName} {
      allow read: if canReadReport(reportId);
      allow write: if canWriteReportNote(reportId) && validAttachmentUpload(15);
    }

    match /dts/{docId}/cover/{fileName} {
      allow read: if canReadDts(docId);
      allow write: if activeUser() && isStaff() && dtsOfficeAllowed(docId) && validImageUpload(10);
    }

    match /dts/{docId}/attachments/{fileName} {
      allow read: if canReadDts(docId);
      allow write: if activeUser() && isStaff() && dtsOfficeAllowed(docId)
        && validAttachmentUpload(15);
    }

    match /dts_qr_codes/{fileName} {
      allow read: if signedIn() && isStaff();
      allow write: if false;
    }

    match /dts_qr_exports/{fileName} {
      allow read: if signedIn() && isStaff();
      allow write: if false;
    }

    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
